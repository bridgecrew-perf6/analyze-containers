<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Restore </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Restore ">
    <meta name="generator" content="docfx 2.56.2.0">
    
    <link rel="shortcut icon" href="../../../../images/favicon.png">
    <link rel="stylesheet" href="../../../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../../../styles/docfx.css">
    <link rel="stylesheet" href="../../../../styles/main.css">
    <meta property="docfx:navrel" content="../../../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    <meta property="docfx:rel" content="../../../../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../../../index.html">
                i2 Analyze Containers
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
          
          <div class="subnav navbar navbar-default">
            <div class="container hide-when-search" id="breadcrumb">
              <ul class="breadcrumb">
                <li></li>
              </ul>
            </div>
          </div>
            <article class="content wrap" id="_content" data-uid="">
<h1 id="restore">Restore</h1>

<p>This section describes the process to restore the Solr collections and Information Store database in SQL Server of an i2 Analyze deployment in a containerized environment.</p>
<h2 id="understanding-the-restore-process">Understanding the restore process</h2>
<p>To restore the data and indexes for a deployment of i2 Analyze, restore the pair of Solr collection and Information Store database backups.</p>
<p>To ensure that the data is restored correctly, restore the pair of backups in the following order:</p>
<ol>
<li>Information Store database</li>
<li>Solr collections</li>
</ol>
<p>If any data has changed in the Information Store after the Solr backup, the Solr index is updated to reflect the contents of the Information Store database when Liberty is started.</p>
<h2 id="preparing-the-environment">Preparing the environment</h2>
<p>Before you can restore the backups, clean down the Solr, ZooKeeper &amp; SQL Server environment if you are not using a clean environment.</p>
<p>See the <code>Simulating Clean down</code> section of the walkthrough script.</p>
<h2 id="stop-the-liberty-servers">Stop the liberty servers</h2>
<p>Before the restore process can begin you must stop the liberty servers. In a this can be done by stopping the containers</p>
<p>The following command is an example of how to stop the liberty containers:</p>
<pre><code class="lang-bash">docker container stop liberty1 liberty2
</code></pre><h2 id="restoring-the-information-store-database">Restoring the Information Store database</h2>
<p>The process of restoring the Information Store database contains the following steps:</p>
<ol>
<li>Running a SQL Server container with a new instance of SQL Server</li>
<li>Creating the Information Store database from the backup file in the new instance</li>
<li>Recreating the required logins in the new SQL Server instance, and the users in the restored database</li>
</ol>
<h3 id="running-a-sql-server-container">Running a SQL Server container</h3>
<p>Run a container for the new instance of SQL Server, this will have the backup directory available. For more information about running a SQL Server container, see <a href="../images%20and%20containers/sql_server.html">SQL Server</a>.</p>
<p>See the <code>Running the SQL Server</code> section of the walkthrough script.</p>
<h3 id="creating-the-database-from-the-backup-file">Creating the database from the backup file</h3>
<p>In a new instance of SQL Server, the only user is the <code>sa</code> user. Use the <code>runSQLServerCommandAsSA</code> client function to run the following SQL command as the <code>sa</code> user to create the <code>ISTORE</code> database from the backup file:</p>
<pre><code class="lang-sh">runSQLServerCommandAsSA bash -c &quot;/opt/mssql-tools/bin/sqlcmd -N -b -C -S sqlserver.eia,1433 -U \&quot;\${DB_USERNAME}\&quot; -P \&quot;\${DB_PASSWORD}\&quot; \
    -Q \&quot;RESTORE DATABASE ISTORE FROM DISK = &#39;/backup/IStore.bak;&#39;&quot;
</code></pre><p>See the <code>Restoring the ISTORE database</code> section of the walkthrough script.</p>
<h3 id="recreating-the-logins-and-users">Recreating the logins and users</h3>
<p>In SQL Server, a login is scoped to the Database Engine. To connect to a specific database, in this case the <code>ISTORE</code> database, a login must be mapped to a database user.
Because the backup is completed for the <code>ISTORE</code> database only, the logins from the previous SQL Server instance cannot be restored. Additionally, the database users are restored but there are no logins mapped to them.</p>
<p>For more information about SQL Server logins, see <a href="https://docs.microsoft.com/en-us/sql/relational-databases/security/authentication-access/create-a-login?view=sql-server-ver15">SQL Server Login documentation</a></p>
<p>In this environment, create the required logins and users by dropping the users from the database and recreating the logins and the users by using the <code>createDbLoginAndUser</code> client function. The logins and users are created in the same way as when original SQL Server instance was configured.</p>
<p>For more information about creating the required logins, users, and permissions, see <a href="../tools%20and%20functions/deploy.html#configuring-sql-server">Configuring SQL Server</a> in the deployment documentation.</p>
<p>See the <code>Dropping existing database users</code> and <code>Recreating database logins, users, and permissions</code> sections of the walkthrough script.</p>
<h2 id="restoring-the-solr-collections">Restoring the Solr collections</h2>
<p>Restoring the solr indexes includes the following high-level steps:</p>
<ul>
<li>Deploy a new Solr cluster and ZooKeeper ensemble</li>
<li>Restore the non-transient Solr collections<ul>
<li>Monitor the restore process until completed</li>
</ul>
</li>
<li>Recreate transient Solr collections</li>
<li>Restore system match rules</li>
</ul>
<h3 id="deploy-a-new-solr-cluster-and-zookeeper-ensemble">Deploy a new Solr cluster and ZooKeeper ensemble</h3>
<p>To restore the Solr indexes, deploy a new Solr cluster &amp; ZooKeeper ensemble. For more information about running a clean ZooKeeper &amp; Solr environment, see</p>
<ul>
<li><a href="../tools%20and%20functions/deploy.html#running-solr-and-zookeeper">Running Solr and ZooKeeper</a>.</li>
<li><a href="../tools%20and%20functions/deploy.html#create-solr-cluster">Create Solr cluster</a>.</li>
</ul>
<p>See the <code>Deploying Clean Solr &amp; Zookeeper</code> section of the walkthrough script.</p>
<h3 id="restoring-the-non-transient-solr-collections">Restoring the non-transient Solr collections</h3>
<p>The <code>runSolrClientCommand</code> client function is used to run the <code>RESTORE</code> API request. The restore operation must be performed for each non-transient collection that was backed up. The following curl command is an example that restores the <code>main_index</code> collection:</p>
<pre><code class="lang-sh">runSolrClientCommand bash -c &quot;curl -u \&quot;\${SOLR_ADMIN_DIGEST_USERNAME}:\${SOLR_ADMIN_DIGEST_PASSWORD}\&quot; --cacert /tmp/i2acerts/CA.cer https://solr1:8983/solr/admin/collections?action=RESTORE&amp;async=main_index_backup&amp;name=main_index_backup&amp;collection=main_index&amp;location=/backup/1&quot;
&quot;
</code></pre><p>To perform a restore operation, use the Solr Collections API. For more information about the Restore API command, see <a href="https://lucene.apache.org/solr/guide/8_7/collection-management.html#restore">RESTORE: Restore Collection</a>.</p>
<blockquote><p>Note: The restore API request must be an asynchronous call otherwise the restore procedure will timeout. This is done by adding <code>async</code> flag with a corresponding id to the curl command. In the above example, this is <code>&amp;async=main_index_backup</code>.</p>
</blockquote>
<p>See the <code>Restoring non-transient Solr collection</code> section of the walkthrough script.</p>
<h2 id="determining-completion-of-solr-restore-procedure">Determining completion of Solr restore procedure</h2>
<p>The <code>Monitoring Solr restore process</code> section of the walkthrough script runs a loop around the <code>getAsyncRequestStatus</code> client function that reports the status of the Asynchronous request. For more information about the client function, see <a href="../tools%20and%20functions/client_functions.html#getAsyncRequestStatus"><code>getAsyncRequestStatus</code></a>.</p>
<p>See the <code>Monitoring Solr restore progress</code> section of the walkthrough script.</p>
<h3 id="recreate-transient-solr-collections">Recreate transient Solr collections</h3>
<p>Recreate the transient <code>daod_index</code>, <code>vq_index</code>, and <code>highlightquery_index</code> Solr collections.</p>
<p>For more information about the creating Solr collections, see <a href="../tools%20and%20functions/deploy.html#configuring-solr-and-zookeeper">Configuring Solr and ZooKeeper</a>.</p>
<p>See the <code>Recreating transient Solr collections</code> section of the walkthrough script.</p>
<h3 id="restore-system-match-rules">Restore system match rules</h3>
<p>After the indexes are restored, upload the system match rules file. Use the Solr ZooKeeper Command Line Interface (zkcli) to create the directory in ZooKeeper for the system match rules file and to upload it.</p>
<p>The <code>runSolrClientCommand</code> client function is used to run the zkcli request.</p>
<p>The following command creates the directory in ZooKeeper where the system match rules file must be stored:</p>
<pre><code class="lang-bash">runSolrClientCommand &quot;/opt/solr/server/scripts/cloud-scripts/zkcli.sh&quot; -zkhost &quot;${ZK_HOST}&quot; -cmd makepath /configs/match_index1/match_index1/app
</code></pre><blockquote><p>Note: The path to where the system match rules file must be located is in the following format <code>configs/&lt;index name&gt;/&lt;index name&gt;/app</code></p>
</blockquote>
<p>The following command uploads the system match rules file to the directory in ZooKeeper created earlier:</p>
<pre><code class="lang-bash">runSolrClientCommand &quot;/opt/solr/server/scripts/cloud-scripts/zkcli.sh&quot; -zkhost &quot;${ZK_HOST}&quot; -cmd putfile /configs/match_index1/match_index1/app/match-rules.xml /backup/1/system-match-rules.xml
</code></pre><p>For more information about the ZooKeeper command line utilities, see <a href="https://lucene.apache.org/solr/guide/8_7/command-line-utilities.html#using-solrs-zookeeper-cli">Using Solr’s ZooKeeper CLI</a>.</p>
<p>See the <code>Restoring system match rules</code> section of the walkthrough script.</p>
<h2 id="start-the-liberty-containers">Start the Liberty containers</h2>
<p>After the Solr collections and Information Store database are restored, start the Liberty containers.</p>
<p>The following command is an example of how to start the Liberty containers:</p>
<pre><code class="lang-bash">docker container start liberty1 liberty2
</code></pre><p>After the Liberty containers have started, the <code>waitFori2AnalyzeServiceToBeLive</code> common function ensures that the i2 Analyze service is running.</p>
<p>See the <code>Restart Liberty containers</code> section of the walkthrough script.</p>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            &copy; N. Harris Computer Corporation (2022)
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../../../styles/main.js"></script>
  </body>
</html>
