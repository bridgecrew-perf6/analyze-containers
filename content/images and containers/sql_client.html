<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>SQL Server Client </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="SQL Server Client ">
    <meta name="generator" content="docfx 2.56.2.0">
    
    <link rel="shortcut icon" href="../../images/favicon.png">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc.html">
    <meta property="docfx:tocrel" content="../toc.html">
    
    <meta property="docfx:rel" content="../../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                i2 Analyze Containers
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list"></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
          
          <div class="subnav navbar navbar-default">
            <div class="container hide-when-search" id="breadcrumb">
              <ul class="breadcrumb">
                <li></li>
              </ul>
            </div>
          </div>
            <article class="content wrap" id="_content" data-uid="">
<h1 id="sql-server-client">SQL Server Client</h1>

<p>An SQL Server Client container is an ephemeral container that is used to run the <code>sqlcmd</code> commands to create and configure the database.</p>
<h2 id="building-an-sql-server-client-image">Building an SQL Server Client image</h2>
<p>The SQL Server Client is built from a Dockerfile that is based on <a href="https://hub.docker.com/_/microsoft-mssql-server">Microsoft SQL Server</a>.</p>
<p>The SQL Server Client image is built from the Dockerfile in <code>images/sql_client</code>.</p>
<h3 id="docker-build-command">Docker build command</h3>
<p>The following <code>docker build</code> command builds the SQL Server Client image:</p>
<pre><code class="lang-bash">docker build -t &quot;sqlserver_client_redhat:4.4.0&quot; images/sql_client
</code></pre><h2 id="running-a-sql-server-client-container">Running a SQL Server Client container</h2>
<p>An SQL Server Client container uses the SQL Server Client image. In the <code>docker run</code> command, you can use <code>-e</code> to pass environment variables to the container. The environment variables are described in <a href="#environment-variables">environment variables</a>.</p>
<p>For more information about the command, see <a href="https://docs.docker.com/engine/reference/run/">docker run reference</a>.</p>
<h3 id="docker-run-command">Docker run command</h3>
<p>The following <code>docker run</code> command runs a SQL Server Client container:</p>
<pre><code class="lang-bash">docker run \
    --rm \
    --name &quot;sqlclient&quot; \
    --network &quot;eia&quot; \
    -v &quot;pre-reqs/i2analyze/toolkit:/opt/toolkit&quot; \
    -v &quot;examples/pre-prod/database-scripts/generated:/opt/databaseScripts/generated&quot; \
    -e SQLCMD=&quot;/opt/mssql-tools/bin/sqlcmd&quot; \
    -e SQLCMD_FLAGS=&quot;-N -b&quot; \
    -e DB_SERVER=&quot;sqlserver.eia&quot; \
    -e DB_PORT=1433 \
    -e DB_NAME=&quot;ISTORE&quot; \
    -e GENERATED_DIR=&quot;/opt/databaseScripts/generated&quot; \
    -e DB_USERNAME=&quot;dba&quot; \
    -e DB_PASSWORD=&quot;DBA_PASSWORD&quot; \
    -e DB_SSL_CONNECTION=true \
    -e SSL_CA_CERTIFICATE=&quot;SSL_CA_CERTIFICATE&quot; \
    &quot;sqlserver_client_redhat:4.4.0&quot; &quot;$@&quot;
</code></pre><p>For an example of the <code>docker run</code> command, see <code>runSQLServerCommandAsETL</code> function in <code>clientFunctions.sh</code> script.
For an example of how to use <code>runSQLServerCommandAsETL</code> function, see <a href="../tools%20and%20functions/client_functions.html#runSQLServerCommandAsETL">runSQLServerCommandAsETL</a>.</p>
<blockquote><p>Note: you can run SQL Server Client container as different users, see <a href="../tools%20and%20functions/client_functions.html#runSQLServerCommandAsDBA"><code>runSQLServerCommandAsDBA</code></a>, <a href="../tools%20and%20functions/client_functions.html#runSQLServerCommandAsSA"><code>runSQLServerCommandAsSA</code></a></p>
</blockquote>
<h2 id="bind-mounts">Bind mounts</h2>
<ul>
<li><p><strong>Secrets</strong>:<br>A directory that contains all of the secrets that this tool requires. Specifically this includes credentials to access ZooKeeper and certificates used in SSL.<br>The directory is mounted to a location in the container defined by the <code>CONTAINER_SECRETS_DIR</code> environment variable. This can then be used by other environment variables such as <code>SSL_CA_CERTIFICATE_FILE</code> to locate the secrets.
In a production environment, the orchestration environment can provide the secrets to the file system or the secrets can be passed in via environment variables. The mechanism that is used here simulates the orchestration system providing the secrets as files. This is achieved by using a bind mount. In production this would not be required.</p>
</li>
<li><p><strong>Toolkit</strong>:<br>For the SQL Server Client to use the tools in <code>/opt/toolkit/i2-tools/scripts</code>,
the toolkit must be mounted into the container.<br>In the example scripts, this is defaulted to <code>/opt/toolkit</code>.</p>
</li>
<li><p><strong>Generated scripts directory</strong>:<br>Some of the i2 Analyze tools generate scripts to be run against the Information Store database. For the SQL Server Client to run these scripts, the directory where they are generated must be mounted into the container.<br>In the example scripts, this is defaulted to <code>/database-scripts/generated</code>. The <code>GENERATED_DIR</code> environment variable must specify the location where the generated scripts are mounted.</p>
</li>
</ul>
<h2 id="environment-variables">Environment variables</h2>
<table>
<thead>
<tr>
<th>Environment Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DB_SERVER</code></td>
<td>The fully qualified domain name of the database server.</td>
</tr>
<tr>
<td><code>DB_PORT</code></td>
<td>Specifies the port number to connect to the Information Store.</td>
</tr>
<tr>
<td><code>DB_NAME</code></td>
<td>The name of the Information Store database.</td>
</tr>
<tr>
<td><code>DB_USERNAME</code></td>
<td>The user.</td>
</tr>
<tr>
<td><code>DB_PASSWORD</code></td>
<td>The password.</td>
</tr>
<tr>
<td><code>GENERATED_DIR</code></td>
<td>The root location where any generated scripts are created.</td>
</tr>
</tbody>
</table>
<p>The following environment variables enable you use SSL</p>
<table>
<thead>
<tr>
<th>Environment variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DB_SSL_CONNECTION</code></td>
<td>See <a href="../security%20and%20users/security.html#secure-environment-variables">Secure Environment variables</a>.</td>
</tr>
<tr>
<td><code>SSL_CA_CERTIFICATE</code></td>
<td>See <a href="../security%20and%20users/security.html#secure-environment-variables">Secure Environment variables</a>.</td>
</tr>
</tbody>
</table>
<h2 id="command-parsing">Command parsing</h2>
<p>When commands are passed to the Solr client by using the <code>&quot;$@&quot;</code> notation, the command that is passed to the container must be escaped correctly. On the container, the command is run using <code>docker exec &quot;$@&quot;</code>. Because the command is passed to the <code>docker run</code> command using <code>bash -c</code>, the command must be maintained as a double quoted string.</p>
<p>For example:</p>
<pre><code class="lang-bash">    runSQLServerCommandAsETL 
    bash -c 
    &quot;/opt/mssql-tools/bin/sqlcmd -N -b
    -S \${DB_SERVER},${DB_PORT} -U \${DB_USERNAME} -P \${DB_PASSWORD} -d \${DB_NAME} 
    -Q \&quot;BULK INSERT ${STAGING_SCHEMA}.${table_name} 
    FROM &#39;/var/i2a-data/${BASE_DATA}/${csv_and_format_file_name}.csv&#39; 
    WITH (FORMATFILE = &#39;/var/i2a-data/${BASE_DATA}/sqlserver/format-files/${csv_and_format_file_name}.fmt&#39;, FIRSTROW = 2)\&quot;&quot;
</code></pre><p>Different parts of the command must be escaped in different ways:</p>
<ul>
<li><code>\${DB_SERVER}</code>,<code>\${DB_USERNAME}</code>, <code>\${DB_PASSWORD}</code>, and <code>\${DB_NAME}</code><br> Because the command uses the container&#39;s local environment variables to obtain the values of these variables, the <code>$</code> is escaped by a <code>\</code>.<br> <code>${DB_PORT}</code> is not escaped because this is an environment variable available to the script calling the client function.</li>
<li><code>\&quot;BULK INSERT ${STAGING_SCHEMA}.${table_name} ... FIRSTROW = 2)\&quot;</code><br> The string value for the <code>-Q</code> argument must be surrounded by <code>&quot;</code> when it is run on the container. The surrounding <code>&quot;</code> are escaped with <code>\</code>.
 The variables that are not escaped in the string are evaluated outside of the container when the function is called.</li>
</ul>
</article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            &copy; N. Harris Computer Corporation (2022)
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
